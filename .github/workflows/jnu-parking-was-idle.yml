name: WAS ì¸í”„ë¼ - ëŒ€ê¸° íƒ€ì„ Scale-Down
on:
    workflow_dispatch:

env:
  TF_CLOUD_ORGANIZATION: sckwon770
  TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
  TF_WORKSPACE: jnu-parking
  CONFIG_DIRECTORY: "./generated/aws/elasticache"
  IMAGE_NAME: jnuparking/jnu-parking-prod

jobs:
    prepare-variables:
        name: ì›Œí¬í”Œë¡œìš° ë³€ìˆ˜ ì¤€ë¹„í•˜ê¸°
        runs-on: ubuntu-latest
        outputs:
            image-name: ${{ steps.setup-env.outputs.image-name }}
        steps:
        - name: Githubì—ì„œ ë ˆí¬ ë°›ì•„ì˜¤ê¸°
          uses: actions/checkout@v3
        - name: ë³€ìˆ˜ ì¶œë ¥í•˜ê¸°
          id: setup-env
          run: |
            echo "image-name=$IMAGE_NAME" >> $GITHUB_OUTPUT

    modify-infra-with-terraform:
        needs: [ prepare-variables ]
        name: ì¸í”„ë¼ ìŠ¤ì¼€ì¼ ë‹¤ìš´
        runs-on: ubuntu-latest
        permissions:
          contents: read
          pull-requests: write
        env:
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        defaults:
            run:
                working-directory: jnu-parking-prod-was/idle
        steps:
            - name: Checkout
              uses: actions/checkout@v3

            - name: Upload Configuration
              uses: hashicorp/tfc-workflows-github/actions/upload-configuration@v1.0.0
              id: plan-upload
              with:
                workspace: ${{ env.TF_WORKSPACE }}
                directory: ${{ env.CONFIG_DIRECTORY }}
                speculative: true

            - name: Create Plan Run
              uses: hashicorp/tfc-workflows-github/actions/create-run@v1.0.0
              id: plan-run
              with:
                workspace: ${{ env.TF_WORKSPACE }}
                configuration_version: ${{ steps.plan-upload.outputs.configuration_version_id }}
                plan_only: true

            - name: Get Plan Output
              uses: hashicorp/tfc-workflows-github/actions/plan-output@v1.0.0
              id: plan-output
              with:
                plan: ${{ fromJSON(steps.plan-run.outputs.payload).data.relationships.plan.data.id }}
              
             
            # - name: Terraform Apply
            #   run: terraform apply -auto-approve

            - name: ë°°í¬ ì™„ë£Œ ìŠ¬ë™ ì•Œë¦¼ ë³´ë‚´ê¸°
              uses: 8398a7/action-slack@v3
              with:
                status: custom
                fields: author, workflowRun, pullRequest
                custom_payload: |
                    {
                        attachments: [{
                            color: '#2E289E',
                            title: 'ğŸ§Š ì¸í”„ë¼ ì¡°ì • ì•Œë¦¼',
                            text: `ì£¼ì°¨ê¶Œ ì‹œìŠ¤í…œ Scale-down ì„±ê³µ! (EC2, RDS, ElastiCache)`,
                            fields: [
                                {
                                    title: 'ë°°í¬ì',
                                    value: `${process.env.AS_AUTHOR}`,
                                    short: true,
                                },
                                {
                                    title: 'ì›Œí¬í”Œë¡œ ë§í¬',
                                    value: `${process.env.AS_WORKFLOW_RUN}`,
                                    short: true,
                                },
                            ]
                        }]
                    }
              env:
                SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    # run-spring-boot:
    #     needs: [ prepare-variables, modify-infra-with-terraform ]
    #     runs-on: [ ubuntu-latest ]
    #     name: ìŠ¤í”„ë§ ë¶€íŠ¸ ê¸°ë™

    #     permissions:
    #         id-token: write
    #         contents: read

    #     steps:
    #         - name: GitHub ì—ì„œ ë ˆí¬ ë°›ì•„ì˜¤ê¸°
    #           uses: actions/checkout@v3

    #         - name: ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
    #           uses: appleboy/ssh-action@master
    #           with:
    #             host: ${{ secrets.PROD_SSH_HOST }}
    #             username: ${{ secrets.PROD_SSH_USERNAME }}
    #             key: ${{ secrets.PROD_SSH_KEY }}
    #             port: ${{ secrets.PROD_SSH_PORT }}
    #             script: |
    #                 sudo docker rm -f $(sudo docker ps -qa)
    #                 sudo docker pull ${{ needs.prepare-variables.outputs.image-name }}:latest
    #                 sudo docker compose up -d --env-file .env.idle
    #                 sudo docker image prune -f

    #         - name: ë°°í¬ ì™„ë£Œ ìŠ¬ë™ ì•Œë¦¼ ë³´ë‚´ê¸°
    #           uses: 8398a7/action-slack@v3
    #           with:
    #             status: custom
    #             fields: author, workflowRun, pullRequest
    #             custom_payload: |
    #                 {
    #                     attachments: [{
    #                         color: '#24C183',
    #                         title: 'âœ… Spring boot ê¸°ë™ ì•Œë¦¼',
    #                         text: `Spring boot ê¸°ë™ ì„±ê³µ!,
    #                         fields: [
    #                             {
    #                                 title: 'ë°°í¬ì',
    #                                 value: `${process.env.AS_AUTHOR}`,
    #                                 short: true,
    #                             },
    #                             {
    #                                 title: 'ì›Œí¬í”Œë¡œ ë§í¬',
    #                                 value: `${process.env.AS_WORKFLOW_RUN}`,
    #                                 short: true,
    #                             },
    #                         ]
    #                     }]
    #                 }
    #           env:
    #             SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}